
DECLARE @dt AS DATETIME

SET @dt = '9/12/2011'

---  TOTAL CHANNELS ----------------------------
select ch.channel_nme,ch.designed_discharge_msr, gd.head_discharge, gd.indent,

(
	SELECT COUNT(CH.CHANNEL_NME)
	FROM CHANNEL CH

	JOIN CHANNEL_CHANGE_OVER CCO ON 
	CH.IMIS_CDE = CCO.IMIS_CDE
	AND CCO.PARENT_IMIS_CDE LIKE RTRIM(CS.PARTIAL_IMIS_CDE)
	AND CH.CHANNEL_TYP NOT IN ('E','DM','HW', 'BC', 'MC')
) as 'Total',
(
--	SELECT COUNT(CH.CHANNEL_NME)
--	FROM CHANNEL CH
--
--	JOIN CHANNEL_CHANGE_OVER CCO ON 
--	CH.IMIS_CDE = CCO.IMIS_CDE
--	AND CCO.PARENT_IMIS_CDE LIKE RTRIM(CS.PARTIAL_IMIS_CDE)
--
--	Left outer JOIN GAUGING_DETAIL GD ON 
--	CH.IMIS_CDE = GD.IMIS_CDE
--	AND GD.RECORDING_DATE = @dt
--	AND CH.CHANNEL_TYP NOT IN ('E','DM','HW', 'BC', 'MC')
--	AND CH.HEAD_ANALYSIS <> 1
--	AND GD.HEAD_DISCHARGE IS NULL
	SELECT COUNT(CHANNEL_NME) FROM
	(
		SELECT DISTINCT CH.CHANNEL_NME, GD.HEAD_DISCHARGE, CH.CHANNEL_TYP
		FROM CHANNEL CH

		JOIN CHANNEL_CHANGE_OVER CCO ON 
		CH.IMIS_CDE = CCO.IMIS_CDE
		AND CCO.PARENT_IMIS_CDE LIKE RTRIM(CS.PARTIAL_IMIS_CDE)

		LEFT OUTER JOIN GAUGING_DETAIL GD ON 
		CH.IMIS_CDE = GD.IMIS_CDE
		AND GD.RECORDING_DATE = @dt
		
		AND CH.HEAD_ANALYSIS <> 1
		--AND GD.HEAD_DISCHARGE IS NULL
	) AS A
	WHERE A.HEAD_DISCHARGE IS NULL
	AND A.CHANNEL_TYP NOT IN ('E','DM','HW', 'BC', 'MC')
) as 'DNR',
(
	SELECT COUNT(CH.CHANNEL_NME)
	FROM CHANNEL CH

	JOIN CHANNEL_CHANGE_OVER CCO ON 
	CH.IMIS_CDE = CCO.IMIS_CDE
	AND CCO.PARENT_IMIS_CDE LIKE RTRIM(CS.PARTIAL_IMIS_CDE)

	JOIN GAUGING_DETAIL GD ON 
	CH.IMIS_CDE = GD.IMIS_CDE
	AND GD.RECORDING_DATE = @dt
	AND CH.CHANNEL_TYP NOT IN ('E','DM','HW', 'BC', 'MC')
	AND CH.HEAD_ANALYSIS <> 1
	AND GD.HEAD_DISCHARGE = 0
) as 'CLOSED',
(
	SELECT COUNT(CH.CHANNEL_NME)
	FROM CHANNEL CH

	JOIN CHANNEL_CHANGE_OVER CCO ON 
	CH.IMIS_CDE = CCO.IMIS_CDE
	AND CCO.PARENT_IMIS_CDE LIKE RTRIM(CS.PARTIAL_IMIS_CDE)

	JOIN GAUGING_DETAIL GD ON 
	CH.IMIS_CDE = GD.IMIS_CDE
	AND GD.RECORDING_DATE = @dt
	AND CH.CHANNEL_TYP NOT IN ('E','DM','HW', 'BC', 'MC')
	AND CH.HEAD_ANALYSIS <> 1
	AND GD.HEAD_DISCHARGE <> 0
	AND GD.HEAD_DISCHARGE < 0.9 * GD.INDENT --CH.DESIGNED_DISCHARGE_MSR
) as 'PARTIAL',
(
	SELECT COUNT(CH.CHANNEL_NME)
	FROM CHANNEL CH

	JOIN CHANNEL_CHANGE_OVER CCO ON 
	CH.IMIS_CDE = CCO.IMIS_CDE
	AND CCO.PARENT_IMIS_CDE LIKE RTRIM(CS.PARTIAL_IMIS_CDE)

	JOIN GAUGING_DETAIL GD ON 
	CH.IMIS_CDE = GD.IMIS_CDE
	AND GD.RECORDING_DATE = @dt
	AND CH.CHANNEL_TYP NOT IN ('E','DM','HW', 'BC', 'MC')
	AND CH.HEAD_ANALYSIS <> 1
	AND GD.HEAD_DISCHARGE <> 0
	AND GD.HEAD_DISCHARGE >= 0.9 * GD.INDENT --CH.DESIGNED_DISCHARGE_MSR
	AND GD.HEAD_DISCHARGE <= 1.15 * GD.INDENT
) as 'AUTHORIZED_Head',
(
	SELECT COUNT(CH.CHANNEL_NME)
	FROM CHANNEL CH

	JOIN CHANNEL_CHANGE_OVER CCO ON 
	CH.IMIS_CDE = CCO.IMIS_CDE
	AND CCO.PARENT_IMIS_CDE LIKE RTRIM(CS.PARTIAL_IMIS_CDE)

	JOIN GAUGING_DETAIL GD ON 
	CH.IMIS_CDE = GD.IMIS_CDE
	AND GD.RECORDING_DATE = @dt
	AND CH.CHANNEL_TYP NOT IN ('E','DM','HW', 'BC', 'MC')
	AND CH.HEAD_ANALYSIS <> 1
	AND GD.HEAD_DISCHARGE <> 0
	AND GD.HEAD_DISCHARGE > 1.15 * GD.INDENT--CH.DESIGNED_DISCHARGE_MSR
) as 'EXCESSIVE',
(
	SELECT COUNT(CH.CHANNEL_NME)
	FROM CHANNEL CH

	JOIN CHANNEL_CHANGE_OVER CCO ON 
	CH.IMIS_CDE = CCO.IMIS_CDE
	AND CCO.PARENT_IMIS_CDE LIKE RTRIM(CS.PARTIAL_IMIS_CDE)

	JOIN GAUGING_DETAIL GD ON 
	CH.IMIS_CDE = GD.IMIS_CDE
	AND GD.RECORDING_DATE = @dt
	AND CH.CHANNEL_TYP NOT IN ('E','DM','HW', 'BC', 'MC')
	AND CH.HEAD_ANALYSIS <> 1
	AND CH.TAIL_ANALYSIS <> 1
	AND GD.HEAD_DISCHARGE <> 0 
	AND GD.TAIL_GAUGE <= 0.3*CH.AUTHORIZED_TAIL_GAUGE
) as 'DRY',
(
	SELECT COUNT(CH.CHANNEL_NME)
	FROM CHANNEL CH

	JOIN CHANNEL_CHANGE_OVER CCO ON 
	CH.IMIS_CDE = CCO.IMIS_CDE
	AND CCO.PARENT_IMIS_CDE LIKE RTRIM(CS.PARTIAL_IMIS_CDE)

	JOIN GAUGING_DETAIL GD ON 
	CH.IMIS_CDE = GD.IMIS_CDE
	AND GD.RECORDING_DATE = @dt
	AND CH.CHANNEL_TYP NOT IN ('E','DM','HW', 'BC', 'MC')
	AND CH.HEAD_ANALYSIS <> 1
	AND CH.TAIL_ANALYSIS <> 1
	AND GD.HEAD_DISCHARGE <> 0 
	AND GD.TAIL_GAUGE > 0.3*CH.AUTHORIZED_TAIL_GAUGE
	AND GD.TAIL_GAUGE < 0.9*CH.AUTHORIZED_TAIL_GAUGE
) as 'SHORT',
(
	SELECT COUNT(CH.CHANNEL_NME)
	FROM CHANNEL CH

	JOIN CHANNEL_CHANGE_OVER CCO ON 
	CH.IMIS_CDE = CCO.IMIS_CDE
	AND CCO.PARENT_IMIS_CDE LIKE RTRIM(CS.PARTIAL_IMIS_CDE)

	JOIN GAUGING_DETAIL GD ON 
	CH.IMIS_CDE = GD.IMIS_CDE
	AND GD.RECORDING_DATE = @dt
	AND CH.CHANNEL_TYP NOT IN ('E','DM','HW', 'BC', 'MC')
	AND CH.HEAD_ANALYSIS <> 1
	AND CH.TAIL_ANALYSIS <> 1
	AND GD.HEAD_DISCHARGE <> 0 
	AND GD.TAIL_GAUGE > 0.9*CH.AUTHORIZED_TAIL_GAUGE
	AND GD.TAIL_GAUGE < 1.15*CH.AUTHORIZED_TAIL_GAUGE
) as 'AUTHORIZED',
(
	SELECT COUNT(CH.CHANNEL_NME)
	FROM CHANNEL CH

	JOIN CHANNEL_CHANGE_OVER CCO ON 
	CH.IMIS_CDE = CCO.IMIS_CDE
	AND CCO.PARENT_IMIS_CDE LIKE RTRIM(CS.PARTIAL_IMIS_CDE)

	JOIN GAUGING_DETAIL GD ON 
	CH.IMIS_CDE = GD.IMIS_CDE
	AND GD.RECORDING_DATE = @dt
	AND CH.CHANNEL_TYP NOT IN ('E','DM','HW', 'BC', 'MC')
	AND CH.HEAD_ANALYSIS <> 1
	AND CH.TAIL_ANALYSIS <> 1
	AND GD.HEAD_DISCHARGE <> 0 
	AND GD.TAIL_GAUGE >= 1.15*CH.AUTHORIZED_TAIL_GAUGE
) as 'EXCESSIVE'
    
from channel ch 

join canal_systems cs on 
cs.imis_cde = ch.imis_cde

Left outer join gauging_detail gd on 
cs.imis_cde = gd.imis_cde
and gd.recording_date = @dt

order by ch.channel_nme
----------------------------------------------------------------
